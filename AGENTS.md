# AGENTS

本リポジトリでのエージェント向け作業規約と実装ガイドです。随時更新してください。

## スコープ / 目的

- このファイルのスコープはリポジトリ全体です。
- 目的: AWCC の Per Game を“逆利用”した最小トレイ常駐 EXE 群（色ごと）と、それらを `configure.yaml` から生成する仕組みの実装・保守。

## 基本ポリシー

- 変更は最小限・局所的に。既存のスタイルを尊重し、無関係な修正は行わない。
- ルート原因に対処する修正を優先し、表層的なワークアラウンドは避ける。
- 重大な仕様追加や方針変更を行う場合は、本 `AGENTS.md` と `README.md` を必ず更新する。

## マークダウン運用（markdownlint）

- 本リポジトリの Markdown は markdownlint に準拠する。
- Mermaid 図の注意:
  - プレースホルダに角括弧 `< >` を使わない。`NAME` などの単語で表記する。
  - GitHub の Mermaid でのプレビューを基準に構文を選ぶ（`graph LR` などシンプルな記法を推奨する）。

## 設計方針（要点）

- ランナー（各 `{name}.exe`）
  - Windows 専用（GUI サブシステム・コンソール非表示）。
  - 起動直後に同系統の他色 EXE を安全に終了し、自分のみ常駐（シングルトン運用）。
  - 隠しウィンドウ＋タスクトレイアイコン＋右クリック「終了」のみ。
  - 終了時にトレイアイコンを確実に撤去。
- ジェネレータ（`configure.yaml` → EXE 群）
  - YAML（UTF-8）。`profiles[].name` は `^[A-Za-z0-9_-]+$` のみ許可。
  - `output_dir` 未指定時は `dist` を既定。
  - 同系統（ファミリー）情報は各 EXE に埋め込むか、同梱設定から起動時にロードする。

## 開発環境 / ビルド

- Rust: `stable-x86_64-pc-windows-gnu` を前提。
- MinGW: MSYS2 UCRT64（`C:\msys64\ucrt64\bin` を PATH へ）。
- crate 候補: `windows`（Win32 API 呼び出し用）、`clap`（CLI）、`serde_yaml`（設定）等。
- VS 不要。GNU ツールチェーンでのビルドが通るようにする。

## コーディング規約（Rust）

- エディション 2021。可読性重視、過度なマクロ・unsafe を避ける（Win32 呼び出しは必要最小限）。
- 1文字変数は使わない。意味のある命名を行う。
- 例外以外での `unwrap()` 乱用を避け、`anyhow::Result` などで文脈を保つ。
- ログは必要最小限。常駐アプリで不要な標準出力は行わない。

## ドキュメント

- README は利用者目線（日本語）で最新状態を維持。図は Mermaid を用いるが、角括弧のプレースホルダは使わない（`NAME` を使用）。
- 重要な仕様変更・生成方法・制限事項は README の該当章を更新。
- 新しい開発ルールや構成の変更は本 `AGENTS.md` も更新。

## Git 運用

- コミットメッセージは「ブランチ名をプレフィックス」にする（Conventional Commits の `feat:` や `docs:` などは使わない）。
  - 形式例: `runner/tray: タスクトレイ実装の最小版`、`generator/init: configure.yaml 解析を追加`、`main: README を更新`
  - 1 コミット 1 意図。短く具体的に（日本語可）。
- ブランチ命名は役割/対象が分かるものにする（例: `runner/...`, `generator/...`, `ci/...`, `docs/...` など）。
- 不要な生成物（`target/`, `dist/`, デバッグ出力）をコミットしない（`.gitignore` を維持）。

## セキュリティ / 権限

- 管理者権限は不要。通常ユーザー権限でのプロセス終了（自作 EXE 群のみ）に限定する。
- 外部サービスや非公開 API への依存を追加しない。

## エージェント向け作業手順（Codex CLI）

- 変更は `apply_patch` で行い、不要な再読込を避ける。
- ネットワークや広範な書き込みが必要な場合は、ユーザーの承認方針に従う。
- 大きな変更や方針追加を行う場合:
  1. README/AGENTS.md を先に更新（markdownlint 準拠）。
  2. 実装を最小差分で追加。
  3. （任意）簡易ビルド手順を記載し、検証観点を提示。

## 今後のタスク例（ロードマップの指針）

- Rust ワークスペース（runner / generator）の作成。
- runner: Win32 メッセージループ＋トレイ実装、起動直後の同系統停止機能。
- generator: `configure.yaml` から `dist/` に EXE 群生成（ファミリー情報の埋め込み）。
- README の運用手順とトラブルシューティング拡充。
- （任意）CI 追加（Windows 上でのビルドのみ）。

---

この `AGENTS.md` は「常に最新」を前提に運用します。仕様・方針・規約を更新した場合は、同一 PR/変更セットで本ファイルも必ず更新してください。
