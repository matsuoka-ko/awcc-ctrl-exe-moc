# AGENTS

本リポジトリでのエージェント（Codex CLI）向け作業規約と実装ガイドです。随時更新してください。

## スコープ / 目的

- スコープはリポジトリ全体です。
- 目的: AWCC の Per Game を“逆利用”した最小トレイ常駐 EXE 群と、`configure.yaml` からの生成仕組みの実装・保守。

## 基本ポリシー

- 変更は最小限・局所的に。既存のスタイルを尊重し、無関係な修正は行わない。
- ルート原因に対処する。表層的なワークアラウンドは避ける。
- 重大な仕様追加や方針変更を行う場合は、本 `AGENTS.md` と `README.md` を必ず更新する。

## ドキュメント / Lint 方針

- 既存のリンター（例: markdownlint）は「規約の唯一のソース」。AGENTS.md で個別ルールは列挙しない。
- 個別ルールを並べると「書かれていないルールは任意」に見えるため、ここでは方針のみ示す。
- 原則としてルールは無効化せず、内容（文書/コード）を修正して順守する。
- 開発者が1人の場合:
  - 人間が直接行う小規模変更は直コミット可。
  - エージェント（Codex CLI など）が作業してコミットまで行う場合は PR を必須とし、自己レビューのうえセルフマージ（CI 通過が前提）。
  - 例外対応や裁量変更は、コミットメッセージか併設 Issue に理由を明記し、設定変更は最小限・同一変更セットで行う。
  - 共同開発に移行したら、すべての変更を PR ベースに切り替える。

## ドキュメント運用（AGENTS / SKILLS）

- 本ファイル（AGENTS.md）は規範（ルール/方針）を記載する。仕様・運用に影響する変更時は必ず更新する。
- 学び・教訓・注意点は SKILLS.md に集約し、作業のたびに随時更新する（非規範）。
- 文量が増えて可読性が下がった場合は、将来 `docs/skills/` などに分割を検討する。

## 設計方針（要点）

- ランナー（各 `NAME.exe`）
  - Windows 専用（GUI サブシステム・コンソール非表示）。
  - 起動直後に同系統の他色 EXE を安全に終了し、自分のみ常駐（シングルトン運用）。
  - 隠しウィンドウ＋タスクトレイアイコン＋右クリック「終了」のみ。
  - 終了時にトレイアイコンを確実に撤去。
- ジェネレータ（`configure.yaml` → EXE 群）
  - YAML（UTF-8）。`profiles[].name` は `^[A-Za-z0-9_-]+$` のみ許可。
  - `output_dir` 未指定時は `dist`。
  - 同系統（ファミリー）情報は各 EXE に埋め込むか、同梱設定から起動時にロード。

## 開発環境 / ビルド

- Rust: `stable-x86_64-pc-windows-gnu`。
- MinGW: MSYS2 UCRT64（`C:\msys64\ucrt64\bin` を PATH に追加）。
- crate 候補: `windows`（Win32 API 呼び出し）、`clap`（CLI）、`serde_yaml`（設定）。
- VS 不要。GNU ツールチェーンでビルド可能にする。

### 運用ノート（環境）

- PATH 追記は `setx` を避け、GUI（`sysdm.cpl` → 環境変数）または PowerShell の .NET API でユーザー Path を編集する（`setx` は 1024 文字制限に注意）。
- PowerShell で実行ファイルの所在確認は `Get-Command <name>` か `where.exe <name>` を使う（`where` は `Where-Object` の別名）。

## コーディング規約（Rust）

- Edition 2021。可読性重視。過度なマクロ・unsafe は避ける（Win32 呼び出しは必要最小限）。
- 一文字変数は使わない。意味のある命名。
- `unwrap()` の乱用を避け、`anyhow::Result` などで文脈を保持。
- 常駐アプリで不要な標準出力は行わない。

## ドキュメント

- README は利用者目線（日本語）で最新に保つ。図のプレースホルダは `NAME` を使用。
- 仕様変更・生成方法・制限事項を変更した場合は README の該当章を更新。
- 開発ルールや構成の変更は本 `AGENTS.md` も更新。

## Git 運用

- コミットメッセージは「ブランチ名をプレフィックス」にする（例: `runner/tray: ...`, `generator/init: ...`, `main: ...`）。
- 1 コミット 1 意図。短く具体的に（日本語可）。
- ブランチ命名は役割/対象が分かるもの（`runner/...`, `generator/...`, `ci/...`, `docs/...` など）。
- 生成物（`target/`, `dist/`）やデバッグ出力はコミットしない（`.gitignore` を維持）。

## エージェント向け作業手順（Codex CLI）

- 変更は `apply_patch` を使い、不要な再読込を避ける。
- ネットワークや広範な書き込みが必要な場合は、ユーザーの承認方針に従う。
- 大きな変更や方針追加を行う場合:
  1. README/AGENTS.md を先に更新。
  2. 実装を最小差分で追加。
  3. （任意）簡易ビルド手順や検証観点を記載。

---

この `AGENTS.md` は「常に最新」を前提に運用します。仕様・方針・規約を更新した場合は、同一変更セット（または PR）で本ファイルも必ず更新してください。
