# AGENTS

本リポジトリでのエージェント（Codex CLI）向け作業規約と実装ガイドです。随時更新してください。

## スコープ / 目的

- スコープはリポジトリ全体です。
- 目的: AWCC の Per Game を“逆利用”した最小トレイ常駐 EXE 群と、`configure.yaml` からの生成仕組みの実装・保守。

## 基本ポリシー

- 変更は最小限・局所的に。既存のスタイルを尊重し、無関係な修正は行わない。
- ルート原因に対処する。表層的なワークアラウンドは避ける。
- 重大な仕様追加や方針変更を行う場合は、本 `AGENTS.md` と `README.md` を必ず更新する。

## ドキュメント / Lint 方針

- 既存のリンター（例: markdownlint）は「規約の唯一のソース」。AGENTS.md で個別ルールは列挙しない。
- 個別ルールを並べると「書かれていないルールは任意」に見えるため、ここでは方針のみ示す。
- 原則としてルールは無効化せず、内容（文書/コード）を修正して順守する。
- 開発者が1人の場合:
  - 人間が直接行う小規模変更は直コミット可。
  - エージェント（Codex CLI など）が作業してコミットまで行う場合は PR を必須とし、自己レビューのうえセルフマージ（CI 通過が前提）。
  - 例外対応や裁量変更は、コミットメッセージか併設 Issue に理由を明記し、設定変更は最小限・同一変更セットで行う。
  - 共同開発に移行したら、すべての変更を PR ベースに切り替える。

### 実務ルール（markdownlint 実行）

- エージェントは Markdown を変更した場合、ローカルで `markdownlint` を実行し、指摘を修正してからハンドオフする（CI の通過を必須とする）。

### ビルドとエラーフィックスの原則

- ソースを変更した場合、エージェントが自分でローカルビルドしてエラーを修正し、成功まで反復する。
  - Rust: `cargo check` → `cargo build --release` を基本とし、該当クレートを最小範囲でビルド（例: `-p runner`, `-p generator`）。
  - 生成フローを伴う変更時は `cargo run --release -p generator -- -c configure.yaml` まで実行し、生成物（`dist/*`）の存在と意図どおりの挙動を確認する。
  - 破壊的操作（削除/初期化）やネットワークを伴う操作、Git 操作はユーザーの指示がない限り実施しない。
  - 実行できない制約がある場合は、その制約と想定手順・代替案を提示する。

### 生成前の前提確認

- 実行中の EXE があると生成時に「使用中」で失敗するため、generator 実行前に off.exe を起動するか、対象 EXE を停止してから生成を行う。

## ドキュメント運用（AGENTS / SKILLS）

- 本ファイル（AGENTS.md）は規範（ルール/方針）を記載する。仕様・運用に影響する変更時は必ず更新する。
- 学び・教訓・注意点は SKILLS.md に集約し、作業のたびに随時更新する（非規範）。
- 文量が増えて可読性が下がった場合は、将来 `docs/skills/` などに分割を検討する。

## 設計方針（要点）

- ランナー（各 `NAME.exe`）
  - Windows 専用（GUI サブシステム・コンソール非表示）。
  - 起動直後に同系統の他色 EXE を安全に終了し、自分のみ常駐（シングルトン運用）。
  - 隠しウィンドウ＋タスクトレイアイコン＋右クリック「終了」のみ。
  - 終了時にトレイアイコンを確実に撤去。
- ジェネレータ（`configure.yaml` → EXE 群）
  - YAML（UTF-8）。`profiles[].name` は `^[A-Za-z0-9_-]+$` のみ許可。
  - `output_dir` 未指定時は `dist`。
  - 同系統（ファミリー）情報は各 EXE に埋め込むか、同梱設定から起動時にロード。

## 開発環境 / ビルド

- Rust: `stable-x86_64-pc-windows-gnu`。
- MinGW: MSYS2 UCRT64（`C:\msys64\ucrt64\bin` を PATH に追加）。
- crate 候補: `windows`（Win32 API 呼び出し）、`clap`（CLI）、`serde_yaml`（設定）。
- VS 不要。GNU ツールチェーンでビルド可能にする。

### 運用ノート（環境）

- PATH 追記は `setx` を避け、GUI（`sysdm.cpl` → 環境変数）または PowerShell の .NET API でユーザー Path を編集する（`setx` は 1024 文字制限に注意）。
- PowerShell で実行ファイルの所在確認は `Get-Command <name>` か `where.exe <name>` を使う（`where` は `Where-Object` の別名）。

## コーディング規約（Rust）

- Edition 2021。可読性重視。過度なマクロ・unsafe は避ける（Win32 呼び出しは必要最小限）。
- 一文字変数は使わない。意味のある命名。
- `unwrap()` の乱用を避け、`anyhow::Result` などで文脈を保持。
- 常駐アプリで不要な標準出力は行わない。

## ドキュメント

- README は利用者目線（日本語）で最新に保つ。図のプレースホルダは `NAME` を使用。
- 仕様変更・生成方法・制限事項を変更した場合は README の該当章を更新。
- 開発ルールや構成の変更は本 `AGENTS.md` も更新。

## Git 運用

- コミットメッセージは「ブランチ名をプレフィックス」にする（例: `runner/tray: ...`, `generator/init: ...`, `main: ...`）。
- 1 コミット 1 意図。短く具体的に（日本語可）。
- ブランチ命名は役割/対象が分かるもの（`runner/...`, `generator/...`, `ci/...`, `docs/...` など）。
- 生成物（`target/`, `dist/`）やデバッグ出力はコミットしない（`.gitignore` を維持）。

## エージェント向け作業手順（Codex CLI）

- 変更は `apply_patch` を使い、不要な再読込を避ける。
- ネットワークや広範な書き込みが必要な場合は、ユーザーの承認方針に従う。
- `gh` コマンドは実行可能。ただしリポジトリへの書き込みが発生する操作（例: `push` / `pull` / `commit` など）は禁止。`status` 等の読み取り専用操作は実行可。
- 大きな変更や方針追加を行う場合:
  1. README/AGENTS.md を先に更新。
  2. 実装を最小差分で追加。
  3. （任意）簡易ビルド手順や検証観点を記載。

### 事実確認と自己検証

- エージェントは回答前に、可能な範囲でローカルの実体を確認する（ファイル内容、設定値、生成物の有無など）。
- 実行可能な範囲で検証（例: lint、設定ファイルの読み取り、生成対象の存在確認）を行い、ユーザーに確認させずに確度の高い回答を返す。
- 実行やネットワークが必要で実施不可な場合は、その旨と代替の確認手順を簡潔に提示する。

---

この `AGENTS.md` は「常に最新」を前提に運用します。仕様・方針・規約を更新した場合は、同一変更セット（または PR）で本ファイルも必ず更新してください。

## 自己チェック（Lint/Build/Test）

- Markdown 変更時は必ずローカルで markdownlint を実行し、指摘解消後にハンドオフする。
- コード変更時は `cargo build`（必要に応じて `-p` で対象限定）→ `cargo test` まで実行し、失敗を自分で修正してから共有する。
- 生成フローの変更時は `cargo run --release -p generator -- -c configure.yaml` を実行し、`dist/` の実体で反映を確認する。

## CI

- 現状: markdownlint（GitHub Actions）を運用中。
- 計画: Windows（GNUツールチェーン）でのビルドワークフロー、タグに連動したリリースアセット作成。
- ドキュメントの表示品質維持: README のバッジ（Rust/ターゲット/ライセンス）は更新時に見直す。
